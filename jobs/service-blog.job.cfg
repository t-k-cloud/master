[tkblog-up]
exe = echo 'tkblog up'
dep[] = service-blog:searchd-reindex
dep[] = service-blog:tkblog-ready
dep[] = service-blog:blog-sync

[tkblog-ready]
exer = root
exe = echo 'tkblog ready'
dep[] = service-blog:create-db-table
dep[] = service-blog:searchd-init

[create-db-table]
exe = curl "http://localhost/tkblog/panel_.php?init=db"
dep[] = service-blog:mysql-tkblog-user
dep[] = service-blog:tkblog-dir-wr-perm
dep[] = service-blog:tkblog-dir-wr-owner
dep[] = service:php-fpm-perm

[httpd-rootdir-link]
exer = root
exe = ln -sf $MASTER_TREE_PATH/proj/tkblog $HTTPD_ROOT/

[mysql-tkblog-user]
exer = root
exe = $JOBSDIR/mysql-add-tkblog-usr.sh
dep[] = service:mysql-setup

[tkblog-dir-wr-perm]
exer = root
exe = sh -c "find $HTTPD_ROOT/tkblog/blog/ -type d | xargs -I{} chmod 775 {}" && sh -c "find $HTTPD_ROOT/tkblog/blog/ -type f | xargs -I{} chmod 664 {}"
dep[] = service-blog:httpd-rootdir-link

[tkblog-dir-wr-owner]
exer = root
exe = sh -c "find $HTTPD_ROOT/tkblog/blog/ -type d | xargs -I{} chown http:http {}" && sh -c "find $HTTPD_ROOT/tkblog/blog/ -type f | xargs -I{} chown http:http {}"
dep[] = service-blog:httpd-rootdir-link

[searchd-init]
exer = root
exe = cd $MASTER_TREE_PATH/proj/tkblog && ./blog-searchd.sh init
dep[] = service-blog:pip-installed

[searchd-start]
exe = cd $MASTER_TREE_PATH/proj/tkblog && ./blog-searchd.sh start && sleep 10
dep[] = service-blog:searchd-kill
dep[] = service-blog:searchd-init

[searchd-reindex]
exe = cd $MASTER_TREE_PATH/proj/tkblog && ./blog-searchd.sh reindex
dep[] = service-blog:searchd-start
dep[] = service-blog:searchd-init

[searchd-kill]
exer = root
exe = cd $MASTER_TREE_PATH/proj/tkblog && ./blog-searchd.sh kill
dep[] = service-blog:searchd-init

[blog-sync]
exe = cd $MASTER_TREE_PATH/proj/tkblog && ./blog-sync.sh

[pip-installed]
exer = root
if_not = which pip
exe = pacman --noconfirm -S python-pip
